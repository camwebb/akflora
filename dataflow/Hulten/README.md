# Converting Hultén’s 1968 Flora from paper to digital

This process was lengthy (many months) and required much operator
input! There is no `README.sh` file to run the whole process. This
`README.md` file describes the general outline of the process.  The
main processing script is `hulten2info`; it now has many options.

See [this page](https://alaskaflora.org/hulten/do?method=about) for a
readable account of the steps. This document is more technical.

The main outputs are i) the XML representation of the book, ii) the
online [web app](https://alaskaflora.org/hulten/) presenting this data
and the images and maps in a user-friendly format (also in this repo
[here](../../alaskaflora.org/hulten/)), and the file `hulten` (here),
contributing the Hulten data to the large taxonomic informatics.

## 1. Scan the book

The PDF called `hulten.pdf` (not in the repo) is placed in this
directory.

## 2. Make directories and extract images

```
mkdir tiff
cd tiff
for p in ...
do
    let pn=$p-20
    echo "Extracting book page $pn (pdf page $p)"
    DIR=`printf "%03d" $pn`
    mkdir $DIR
    pdfimages -f $p -l $p ../hulten.pdf $DIR/$pn
    convert $DIR/$pn-000.ppm $DIR/$pn.tiff
    rm -f $DIR/$pn*p[bp]m
done
```

## 3. OCR and manually parse into fields

This is a long process!  In general, e.g., 

      $ hulten2info       367
      $ hulten2info --tes 367

This should open an editor with the text to be parsed (see conventions
below). About 70% of pages work as is, about 30% need adjustment (see
‘Fixing’ below).

The `gen+sp_list` file used by `tesseract` to get better OCR for names
was generated by SQL from the main names database: ‘select distinct
genus from names where can = 1 ; select distinct species from names
where can = 1 ; select distinct ssp from names where can = 1 ;’

### Text parsing convertions and decisions

General format, 6 blocks sparated by empty lines (checked on
2021-04-21). A dash is used as a place marker when no text for that
block appears in account.

**Block 1**: one line only. `matchable_name` [ `/ Hulten_name` ]?
[ `| common name` ]?.  `Hulten_name` is the default infraspecific name
Hulten gives when another infraspecific taxa is given. Sometimes
(rarely) this term will be of the form `subsp. multiflora var. frigida
(Buchenau) Sam.` when the full Hulten name was `Luzula multiflora
(Retz.) Lej. subsp. multiflora var. frigida (Buchenau) Sam.` and the
matchable name is `Luzula multiflora var. frigida (Buchenau) Sam.` On
2021-01-14 I went back through every treatment up to p416 to double
check this, scanning for infra name the same as sp name, but without
an author.

**Block 2**: synonyms of the `matchable_name`. Where Hulten has added
a default infrapecific epithet, the synonyms refer to _species_ name
(which is the `matchable_name`.  Where the `matchable_name` is an
infraspecific name, sometimes Hulten provides synonyms for the
species. These are included, but behind `;SPSYN`, as
comments. Information for a synonym that is not part of a standard
name and authority are included behind `;`. All text after `;` will
not be parsed. On 2021-04-21 I checked for any synonyms of the form
`Genus species Author (var.|subsp.) infra ...` and removed the species
`Author`.
   
The following blocks more-or-less reflect the paragraph structure in
H., but H. was not 100% strict, and occasionally combined two sections
in one, or reverse the order.

**Block 3**: Description

**Block 4**: Ecology notes. And “Described from...” which ususally in
H. occurs in the same paragraph.

**Block 5**: Taxonomy notes

**Block 6**: Cultural/usage notes

### Fixing

      $ hulten2info       367
      $ hulten2info --tes 367
      
If the illutration causes the incorrect parsing:

 1. Edit the page in gimp. Ctrl-R to select, Shft-B to paint selection white
    Overwrite
 2. `$ hulten2info --nop 367`
 3. Check
 4. `$ hulten2info --pgo 367`
 5. In GThumb, crop the image that caused the fail, and Save As the now missing
    Image
 6. `$ hulten2info --tes 367`

### (Notes)

2020-02-07: To save time, I stopped giving the full original name for
subspecies with the authorship for the species. Also stopped making
initial letters of specific epithets into lowercase. Can be fixed with
software.

2020-02-12: Realized that where H gives ‘S. sp Auth. subsp. s’ and
there is another subsp. ‘y’, he is just being strict by creating a
subsp. s with no auth. But to match these, they should be just ‘S. sp
Auth.’ : 035 1; 025 1; 027 1; 028 2; 049 1; 090 1; 094 2; 094 3; 107
2; 111 2; 112 1; 117 1; 129 2; 129 3; 149 3; 153 1; 174 2; 185 2; 187
1; 188 2; 188 3; 193 2; 194 1; 195 2; 201 1

Keys not OCRd. Files named <page>-k1, <page>-k2 ... 

## 4. Extract specimen long/lat points from images

See [this](../../pages_md/blog10.md) blog entry. The script is
`map2points/map2points`. The info is written into a CSV file in the
page’s directory under `tiff/`.

## 5. Collect the info in one file

      $ hulten2info --col [ xml | data ]

Either an XML file is created, or a pipe-delimited file with all data
fields, or just the names and synomyms.

